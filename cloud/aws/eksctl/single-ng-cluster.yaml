--- 
apiVersion: eksctl.io/v1alpha5
kind: ClusterConfig

metadata:
  name: single-ng-lb-controller
  version: "1.22"
  region: eu-central-1

vpc:
  clusterEndpoints:
    publicAccess: true
    privateAccess: true
  id: vpc-0d6aa2304efd1cae4
  subnets:
    #public:
    #  public-one:
    #    id: subnet-05e69719d6fa2cb94
    #  public-two:
    #    id: subnet-0d86cd2f70222c1b2
    private:
      private-one:
        id: subnet-0f2ea9bb43de20750
      private-two:
        id: subnet-03799dc81d15f5995

nodeGroups:
  - name: default
    instanceType: t3a.large
    minSize: 2
    maxSize: 5
    desiredCapacity: 2
    amiFamily: Bottlerocket
    privateNetworking: true
    volumeSize: 20
    volumeType: gp2
    volumeEncrypted: true
    disableIMDSv1: true
    labels:
      nodegroup-type: default

iam:
  withOIDC: true
  serviceAccounts:
  - metadata:
      name: aws-load-balancer-controller
      namespace: kube-system
    attachPolicy:
      Version: "2012-10-17"
      Statement:
      - Effect: Allow
        Action:
        - "iam:CreateServiceLinkedRole"
        Resource: '*'
        Condition:
          StringEquals:
            "iam:AWSServiceName": "elasticloadbalancing.amazonaws.com"
      - Effect: Allow
        Action:
        - "acm:DescribeCertificate"
        - "acm:ListCertificates"
        - "acm:GetCertificate"
        Resource: '*'
      - Effect: Allow
        Action:
        - "ec2:DescribeAccountAttributes"
        - "ec2:DescribeAddresses"
        - "ec2:DescribeAvailabilityZones"
        - "ec2:DescribeInternetGateways"
        - "ec2:DescribeVpcs"
        - "ec2:DescribeVpcPeeringConnections"
        - "ec2:DescribeSubnets"
        - "ec2:DescribeSecurityGroups"
        - "ec2:DescribeInstances"
        - "ec2:DescribeNetworkInterfaces"
        - "ec2:DescribeTags"
        - "ec2:GetCoipPoolUsage"
        - "ec2:DescribeCoipPools"
        - "elasticloadbalancing:DescribeLoadBalancers"
        - "elasticloadbalancing:DescribeLoadBalancerAttributes"
        - "elasticloadbalancing:DescribeListeners"
        - "elasticloadbalancing:DescribeListenerCertificates"
        - "elasticloadbalancing:DescribeSSLPolicies"
        - "elasticloadbalancing:DescribeRules"
        - "elasticloadbalancing:DescribeTargetGroups"
        - "elasticloadbalancing:DescribeTargetGroupAttributes"
        - "elasticloadbalancing:DescribeTargetHealth"
        - "elasticloadbalancing:DescribeTags"
        - "elasticloadbalancing:CreateLoadBalancer"
        - "elasticloadbalancing:CreateTargetGroup"
        - "elasticloadbalancing:CreateListener"
        - "elasticloadbalancing:DeleteListener"
        - "elasticloadbalancing:CreateRule"
        - "elasticloadbalancing:DeleteRule"
        - "elasticloadbalancing:AddTags"
        - "elasticloadbalancing:RemoveTags"
        - "elasticloadbalancing:ModifyLoadBalancerAttributes"
        - "elasticloadbalancing:SetIpAddressType"
        - "elasticloadbalancing:SetSecurityGroups"
        - "elasticloadbalancing:SetSubnets"
        - "elasticloadbalancing:DeleteLoadBalancer"
        - "elasticloadbalancing:ModifyTargetGroup"
        - "elasticloadbalancing:ModifyTargetGroupAttributes"
        - "elasticloadbalancing:DeleteTargetGroup"
        - "elasticloadbalancing:RegisterTargets"
        - "elasticloadbalancing:DeregisterTargets"
        - "elasticloadbalancing:SetWebAcl"
        - "elasticloadbalancing:ModifyListener"
        - "elasticloadbalancing:AddListenerCertificates"
        - "elasticloadbalancing:RemoveListenerCertificates"
        - "elasticloadbalancing:ModifyRule"
        Resource: '*'
      - Effect: Allow
        Action:
        - "cognito-idp:DescribeUserPoolClient"
        - "acm:ListCertificates"
        - "acm:DescribeCertificate"
        - "iam:ListServerCertificates"
        - "iam:GetServerCertificate"
        - "waf-regional:GetWebACL"
        - "waf-regional:GetWebACLForResource"
        - "waf-regional:AssociateWebACL"
        - "waf-regional:DisassociateWebACL"
        - "wafv2:GetWebACL"
        - "wafv2:GetWebACLForResource"
        - "wafv2:AssociateWebACL"
        - "wafv2:DisassociateWebACL"
        - "shield:GetSubscriptionState"
        - "shield:DescribeProtection"
        - "shield:CreateProtection"
        - "shield:DeleteProtection"
        Resource: '*'
      - Effect: Allow
        Action:
        - "ec2:AuthorizeSecurityGroupIngress"
        - "ec2:RevokeSecurityGroupIngress"
        - "ec2:CreateSecurityGroup"
        - "ec2:CreateTags"
        - "ec2:DeleteTags"
        - "ec2:AuthorizeSecurityGroupIngress"
        - "ec2:RevokeSecurityGroupIngress"
        - "ec2:DeleteSecurityGroup"
        Resource: '*'
      - Effect: Allow
        Action:
        - "cognito-idp:DescribeUserPoolClient"
        Resource: '*'
      - Effect: Allow
        Action:
        - "waf-regional:GetWebACLForResource"
        - "waf-regional:GetWebACL"
        - "waf-regional:AssociateWebACL"
        - "waf-regional:DisassociateWebACL"
        Resource: '*'
      - Effect: Allow
        Action:
        - "tag:GetResources"
        - "tag:TagResources"
        Resource: '*'
      - Effect: Allow
        Action:
        - "waf:GetWebACL"
        Resource: '*'
